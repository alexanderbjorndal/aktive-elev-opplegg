{% extends "base.html" %} {% block title %}Lag ny bruker{% endblock %} {% block
content %}
<div class="login-container">
  <h3 align="center">Lag ny bruker</h3>

  <!-- Step 1: Enter email -->
  <div id="email-step">
    <form id="email-form">
      <div class="form-group">
        <input
          type="email"
          class="form-control"
          id="email"
          name="email"
          placeholder="Skriv inn epost"
          required
        />
      </div>
      <button type="submit" class="btn btn-primary" align="center">
        Fortsett
      </button>
    </form>
    <p id="email-error" style="color: red; display: none; margin-top: 0.5rem">
      For å lage en bruker må du ha en godkjent epost. Send mail til
      <a
        id="email-link"
        href="mailto:alexandebj@afk.no?subject=Forespørsel%20om%20godkjent%20epost"
      >
        alexandebj@afk.no
      </a>
      for å få en godkjent epost.
    </p>
  </div>

  <script>
    const emailInput = document.getElementById("email");
    const emailLink = document.getElementById("email-link");

    emailInput.addEventListener("input", () => {
      let userEmail = encodeURIComponent(emailInput.value.trim());
      userEmail = userEmail.replace(/%40/g, "@");
      const subject = encodeURIComponent("Forespørsel om å godkjenne epost");
      const body = encodeURIComponent(
        `Hei Alexander!\n\nJeg vil gjerne ha tilgang til å lage en bruker på nettsiden din "Opplegg for aktive elever" med epostadressen ${userEmail}\n\nJeg forstår at du manuelt må godkjenne meg og at dette kan ta lang tid.`
      );
      emailLink.href = `mailto:alexandebj@afk.no?subject=${subject}&body=${body}`;
    });
  </script>

  <!-- Step 2: Complete signup -->
  <div id="signup-step" style="display: none">
    <form method="POST" class="login-form">
      <input type="hidden" id="approved-email" name="email" />

      <div class="form-group">
        <input
          type="text"
          class="form-control"
          id="firstName"
          name="firstName"
          placeholder="Skriv inn navn"
          required
        />
      </div>

      <div class="form-group">
        <input
          type="password"
          class="form-control"
          id="password1"
          name="password1"
          placeholder="Skriv inn passord"
          required
        />
      </div>

      <div class="form-group">
        <input
          type="password"
          class="form-control"
          id="password2"
          name="password2"
          placeholder="Bekreft passordet"
          required
        />
      </div>

      <div class="form-group">
        <input
          type="password"
          class="form-control"
          id="one_time_password"
          name="one_time_password"
          placeholder="Skriv inn engangskode"
          required
        />
      </div>

      <button type="submit" class="btn btn-primary">Lag ny bruker</button>
    </form>
  </div>

  <div class="form-footer">
    <p>Har du allerede en konto? <a href="/login">Logg inn her</a></p>
  </div>
</div>

<script>
  const emailForm = document.getElementById("email-form");
  const emailStep = document.getElementById("email-step");
  const signupStep = document.getElementById("signup-step");
  const emailError = document.getElementById("email-error");
  const approvedEmailInput = document.getElementById("approved-email");

  emailForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value;

    const response = await fetch("/check-email", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email }),
    });

    const data = await response.json();

    if (data.approved) {
      approvedEmailInput.value = email;
      emailStep.style.display = "none";
      signupStep.style.display = "block";
      emailError.style.display = "none";
    } else {
      emailError.style.display = "block";
    }
  });
</script>
{% endblock %}
